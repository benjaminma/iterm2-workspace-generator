'use strict';

angular.module('iterm2WorkspaceGeneratorApp')
  .directive('wsTerm', function () {
    return {
      templateUrl: 'app/wsTerm/wsTerm.html',
      restrict: 'EA',
      link: function (scope, element, attrs) {
      },
      controller: function ($scope, $log) {
        var ctrl = $scope;
        var tabList = [];
        ctrl.tabList = tabList;
        ctrl.sortableOptions = {};
        ctrl.workspaceName = '';
        ctrl.workspaceOutput = '';

        var tabCount = 0;
        var createNewTab = function (makeActive) {
          var newTab = {
            id: tabCount,
            def: {
              title: 'Tab ' + (tabCount + 1),
              path: '~/',
              commands: '',
              background: 0
            }
          };
          tabList.push(newTab);

          if (makeActive) {
            setActiveTab(newTab);
          }
          
          tabCount++;
        };
        ctrl.createNewTab = createNewTab;

        var setActiveTab = function (tab) {
          _.each(tabList, function (t) {
            t.active = false;
          });
          tab.active = true;
        };
        ctrl.setActiveTab = setActiveTab;

        var removeTabByIndex = function (idx) {
          var tabToRemove = tabList[idx];
          tabList.splice(idx, 1);
          if (tabToRemove.active && tabList.length > 0) {
            if (tabList.length > idx) {
              setActiveTab(tabList[idx]);
            } else {
              setActiveTab(tabList[idx - 1]);
            }
          }
        };
        ctrl.removeTabByIndex = removeTabByIndex;

        var backgroundColors = [
          {
            name: 'black',
            value: '{5120, 5120, 5120}',
            rgb: 'RGB(20, 20, 20)'
          },
          {
            name: 'blue',
            value: '{0, 0, 32768}',
            rgb: 'RGB(0, 0, 128)'
          },
          {
            name: 'red',
            value: '{32768, 0, 0}',
            rgb: 'RGB(128, 0 , 0)'
          },
          {
            name: 'white',
            value: '{65535, 65535, 65535}',
            rgb: 'RGB(255, 255, 255)'
          }
        ];
        ctrl.backgroundColors = backgroundColors;

        // TODO: Use a template...
        var SCRIPT_PREFIX = '-- Generated by iterm2workspace.com on ' + new Date() + ' \n--\n';
        var SCRIPT_SUFFIX = '';

        var generateAppleScriptRecordFromTabDef = function (def) {
          var script;
          var record = [];
          record.push('{title: "');
          record.push(def.title);
          record.push('", path: "');
          record.push(def.path);
          record.push('", commands: "');
          record.push(def.commands);
          record.push('", background: ');
          record.push(backgroundColors[def.background].value);
          record.push('}');
          script = record.join('');
          return script;
        };

        var generateAppleScriptWorkChunks = function (arr) {
          var script = [];
          var records = [];
          var i, l;
          for (i = 0, l = arr.length; i < l; i++) {
            records.push(generateAppleScriptRecordFromTabDef(arr[i].def));
          }
          for (i = 0; i < l; i++) {
            script.push('set workChunk' + (i + 1) + ' to ' + records[i]);
          }
          // var script = 'set workChunks to {' + records.join(',') + '}';
          script = script.join('\n');
          return script;
        };

        var generateAppleScript = function () {
          var arr = $scope.tabList;
          var output = SCRIPT_PREFIX + generateAppleScriptWorkChunks(arr); + SCRIPT_SUFFIX;
          ctrl.workspaceOutput = output;
        };
        var debouncedGenerateAppleScript = _.debounce(generateAppleScript, 250, {leading: true, maxWait: 500, trailing: true});

        var watchTabList = ctrl.$watch('tabList', function (newVal) {
          debouncedGenerateAppleScript();
        }, true);

        var selectAllOutput = function (event) {
          var elem = event.target;
          if (elem) {
            elem.focus();
            elem.select();
          }
        };
        ctrl.selectAllOutput = selectAllOutput;

        var init = function () {
          createNewTab(true);
          debouncedGenerateAppleScript();
        };
        init();
      },
      controllerAs: 'termCtrl'
    };
  });